<main class="signup-container">
  <div class="signup-box">
    <h2>Create a new account</h2>
    <p>It's quick and easy.</p>
    <hr>

    <%= form_for(resource, as: :user, url: registration_path(:user), html: { autocomplete: "off" }) do |f| %>
      <%= render 'devise/shared/error_messages', resource: resource %>

      <!-- Full Name -->
      <label class="field-label">Full Name:</label>
      <div class="form-row double">
        <div class="form-group">
          <%= f.text_field :first_name, placeholder: "First name", class: "form-input", autocomplete: "off" %>
        </div>
        <div class="form-group">
          <%= f.text_field :last_name, placeholder: "Last name", class: "form-input", autocomplete: "off" %>
        </div>
      </div>

      <!-- DOB -->
      <label class="field-label">Date of Birth:</label>
      <%= f.date_select :dob, { start_year: 1950, end_year: Date.today.year - 5 }, { class: "form-input", style: "width: 30%; margin-bottom: 1rem;" } %>

      <!-- Gender -->
      <label class="field-label">Gender:</label>
      <div class="form-row triple gender-options">
        <label><%= f.radio_button :gender, "Female" %><span>Female</span></label>
        <label><%= f.radio_button :gender, "Male" %><span>Male</span></label>
        <label><%= f.radio_button :gender, "Custom" %><span>Other</span></label>
      </div>

      <!-- Email/Phone Toggle -->
      <label><input type="radio" name="registration_method" value="email" checked onchange="toggleRegistrationMethod()"> Email</label>
      <label><input type="radio" name="registration_method" value="phone" onchange="toggleRegistrationMethod()"> Phone</label>

      <!-- Email Field -->
      <div id="email_field">
        <label class="field-label">Enter your Email:</label>
        <%= f.email_field :email, placeholder: "Enter email", class: "form-input", autocomplete: "off" %>
      </div>

      <!-- Phone Field -->
      <div id="phone_field" style="display: none;">
        <label class="field-label">Select your Country:</label>
        <div class="form-row double">
          <select id="country_code" name="country_code" class="form-input"></select>
          <label class="field-label">Enter phone Number:</label>
          <%= f.text_field :phone, placeholder: "Phone number", class: "form-input" %>
        </div>
      </div>

      <!-- Password Fields -->
      <div class="password-wrapper">
        <label class="field-label">Select your password:</label>
        <div class="form-row" style="position: relative;">
          <%= f.password_field :password, placeholder: "Password", class: "form-input", id: "user_password", autocomplete: "new-password" %>
          <%= f.password_field :password_confirmation, placeholder: "Confirm Password", class: "form-input", id: "user_password_confirmation", autocomplete: "new-password" %>
          <span class="toggle-eye" onclick="togglePassword()" style="position: absolute; right: 12px; top: 25%; transform: translateY(-50%); cursor: pointer; font-size: 18px;">üëÅÔ∏è</span>
        </div>
        <div id="password-strength" style="margin-top: 5px;"></div>
        <button type="button" class="generate-btn" onclick="openPasswordModal()">Generate Secure Password</button>
      </div>

      <!-- Modal -->
      <div id="passwordModal" class="modal" onclick="clickOutsideModal(event)">
        <div class="modal-content">
          <h3>Suggested Password</h3>
          <input type="text" id="suggestedPassword" readonly />
          <div class="modal-buttons">
            <button onclick="copyPassword()">üìã Copy</button>
            <button onclick="useSuggestedPassword()">‚úÖ Use</button>
            <button onclick="generatePassword()">üîÅ</button>
          </div>
        </div>
      </div>

      <!-- Terms -->
      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="terms-agree" required>
          <span>I agree to the <a href="#">Terms</a>, <a href="#">Privacy Policy</a>, and <a href="#">Cookies Policy</a>.</span>
        </label>
      </div>

      <!-- reCAPTCHA v2 -->
      <div class="recaptcha-container" style="margin-top: 1rem;">
        <div id="g-recaptcha-container"></div>
        <% if flash[:recaptcha_error] %>
          <div class="error-message"><%= flash[:recaptcha_error] %></div>
        <% end %>
      </div>

      <%= f.submit "Sign Up" %>
    <% end %>

    <p class="form-footer">
      Already have an account? <%= link_to "Log in", new_user_session_path %>
    </p>
  </div>
</main>
<!-- Include external JS libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/libphonenumber-js/1.10.20/libphonenumber-js.min.js"></script>

<!-- reCAPTCHA script with explicit render to ensure it's visible -->
<script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
<script>
  function onRecaptchaLoad() {
    // Explicitly render the reCAPTCHA widget
    grecaptcha.render('g-recaptcha-container', {
      'sitekey': '<%= Rails.application.credentials.dig(:recaptcha, :site_key) || ENV["RECAPTCHA_SITE_KEY"] %>',
      'callback': onRecaptchaVerified,
      'expired-callback': onRecaptchaExpired
    });
  }

  function onRecaptchaVerified(token) {
    console.log('reCAPTCHA verified');
    // You can add additional logic here if needed
  }

  function onRecaptchaExpired() {
    console.log('reCAPTCHA expired');
    // You can add additional logic here if needed
  }
</script>

<!-- Include JavaScript files -->
<%= javascript_include_tag "registration" %>