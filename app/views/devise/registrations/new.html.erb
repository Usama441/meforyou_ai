<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RENATA - Emotional Support Platform</title>
  <%= csrf_meta_tags %>
</head>
<body>
<header class="header">
  <div class="header-container">
    <div class="logo">
      <div class="logo-icon">R</div>
      <div class="logo-text">RENATA</div>
    </div>

    <nav>
      <ul class="nav-menu">
        <li><a href="#">Home</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Services</a></li>
        <li><a href="#">Resources</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </nav>

    <div class="header-actions">
      <%= link_to "Login", new_user_session_path, class: "btn-header btn-login" %>
      <%= link_to "Sign Up", new_user_registration_path, class: "btn-header btn-signup" %>
    </div>
  </div>

</header>

<div class="main-content">

<div class="signup-container">
  <div class="ai-badge">RENATA</div>
  <div class="signup-header">
    <h2>Emotional Support Account</h2>
    <p>Your journey to emotional wellbeing starts here</p>
  </div>

  <div class="emotional-support-tagline">
    Creating a safe space for your emotional growth
  </div>

  <div class="step-indicators">
    <div class="step-indicator active" data-step="1">
      <div class="step-node">1</div>
      <div class="step-name">Personal Info</div>
    </div>
    <div class="step-indicator" data-step="2">
      <div class="step-node">2</div>
      <div class="step-name">Profile</div>
    </div>
    <div class="step-indicator" data-step="3">
      <div class="step-node">3</div>
      <div class="step-name">Contact</div>
    </div>
    <div class="step-indicator" data-step="4">
      <div class="step-node">4</div>
      <div class="step-name">Security</div>
    </div>
    <div class="step-indicator" data-step="5">
      <div class="step-node">5</div>
      <div class="step-name">Complete</div>
    </div>
  </div>

  <div class="form-content">
    <%= form_for(resource, as: :user, url: registration_path(:user), html: { id: "signupForm", autocomplete: "off" }) do |f| %>
      <!-- STEP 1: Name -->
      <div class="step step-1 active">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <div class="form-row double">
            <%= f.text_field :first_name, class: "form-input", placeholder: "First name", required: true, id: "firstName" %>
            <%= f.text_field :last_name,  class: "form-input", placeholder: "Last name",  required: true, id: "lastName" %>
          </div>
          <% if @user.errors[:first_name].present? || @user.errors[:last_name].present? %>
            <div class="error-message">Please enter your full name</div>
          <% end %>
        </div>
      </div>

      <!-- STEP 2: Age & Gender -->
      <div class="step step-2">
        <div class="form-group">
          <label class="form-label">Date of Birth</label>

          <!-- Visible input with your custom calendar -->
          <div class="date-input-container">
            <input type="text" class="form-input" id="dob_display" placeholder="Select your birth date" readonly required>
            <span class="calendar-icon">üìÖ</span>

            <div class="calendar-container" id="calendarContainer">
              <div class="calendar-header">
                <button class="nav-button" id="prevButton" type="button">‚ùÆ</button>
                <div class="month-year" id="monthYear"></div>
                <button class="nav-button" id="nextButton" type="button">‚ùØ</button>
              </div>

              <div class="breadcrumb" id="breadcrumb"></div>
              <div id="calendarView"></div>
              <div class="view-indicator" id="viewIndicator">Click on month/year to change view</div>
            </div>
          </div>

          <!-- Hidden Rails field actually submitted -->
          <%= f.hidden_field :dob, id: "dob_hidden" %>

          <% if @user.errors[:dob].present? %>
            <div class="error-message">Please select your date of birth</div>
          <% end %>
        </div>

        <div class="form-group">
          <label class="form-label">Gender</label>
          <div class="form-row triple">
            <label>
              <%= f.radio_button :gender, "female", required: true %>
              <span>Female</span>
            </label>
            <label>
              <%= f.radio_button :gender, "male", required: true %>
              <span>Male</span>
            </label>
            <label>
              <%= f.radio_button :gender, "other", required: true %>
              <span>Other</span>
            </label>
          </div>
          <% if @user.errors[:gender].present? %>
            <div class="error-message">Please select your gender</div>
          <% end %>
        </div>
      </div>

      <!-- STEP 3: Verification Method -->
      <div class="step step-3">
        <div class="form-group">
          <label class="form-label">Verification Method</label>
          <div class="verification-method">
            <%= f.radio_button :verification_method, "email", checked: true, id: "emailMethod" %>
            <label for="emailMethod">Email</label>

            <%= f.radio_button :verification_method, "phone", id: "phoneMethod" %>
            <label for="phoneMethod">Phone</label>
          </div>
        </div>

        <div class="form-group" id="emailField">
          <label class="form-label">Email Address</label>
          <%= f.email_field :email, class: "form-input", placeholder: "Enter your email", id: "email" %>
          <% if @user.errors[:email].present? %>
            <div class="error-message">Please enter a valid email address</div>
          <% end %>
        </div>

        <div class="form-group" id="phoneField" style="display: none;">
          <label class="form-label">Phone Number</label>
          <div class="form-row double">
            <%= f.select :country_code,
                         options_for_select([["+1 US","+1"],["+44 UK","+44"],["+91 IN","+91"],["+61 AU","+61"],["+81 JP","+81"]], @user.country_code),
                         {}, class: "form-input", id: "countryCode" %>
            <%= f.telephone_field :phone, class: "form-input", placeholder: "Phone number", id: "phone" %>
          </div>
          <% if @user.errors[:phone].present? %>
            <div class="error-message">Please enter a valid phone number</div>
          <% end %>
        </div>
      </div>

      <!-- STEP 4: Password -->
      <div class="step step-4">
        <div class="form-group">
          <label class="form-label">Password</label>
          <%= f.password_field :password, class: "form-input", placeholder: "Create a password", id: "password", required: true, minlength: 8 %>
          <span class="toggle-password-signup">&#128065;</span>
          <div class="password-strength">
            <div class="password-strength-meter" id="strengthMeter"></div>
          </div>
          <% if @user.errors[:password].present? %>
            <div class="error-message">Password must be at least 8 characters</div>
          <% end %>
        </div>

        <div class="form-group">
          <label class="form-label">Confirm Password</label>
          <%= f.password_field :password_confirmation, class: "form-input", placeholder: "Confirm your password", id: "confirmPassword", required: true %>
          <span class="toggle-password-signup-con">&#128065;</span>
          <% if @user.errors[:password_confirmation].present? %>

            <div class="error-message">Passwords do not match</div>
          <% end %>
        </div>
      </div>

      <!-- STEP 5: Security & Terms -->
      <div class="step step-5">
        <div class="form-group">
          <label class="form-label">Human Verification</label>
          <div class="form-group">
            <div class="captcha-container">
              <%= recaptcha_tags %>
            </div>
          </div>
          <% if flash.now[:captcha_error] %>
            <div class="error-message"><%= flash.now[:captcha_error] %></div>
          <% end %>
        </div>

        <div class="checkbox-group">
          <label>
            <%= f.check_box :terms_agree, id: "termsAgree", required: true %>
            <span>I agree to the <%= link_to "Terms of Service", "#" %>, <%= link_to "Privacy Policy", "#" %>, and <%= link_to "Cookie Policy", "#" %></span>
          </label>
          <% if @user.errors[:terms_agree].present? %>
            <div class="error-message">You must agree to the terms</div>
          <% end %>
        </div>
      </div>

      <div class="step-buttons">
        <button type="button" class="btn btn-secondary" id="prevBtn" disabled>Previous</button>
        <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
        <!-- Final actual submit (hidden, click it programmatically on final step) -->
        <%= f.submit "Create Account", class: "btn btn-primary", id: "submitBtn", style: "display:none" %>
      </div>
    <% end %>
  </div>

  <div class="form-footer">
    Already have an account?<%= link_to "Log in", new_user_session_path %>
  </div>
  </div>
</div>

<div class="notification" id="notification"><%= notice || alert %></div>
<script>
    /* ------------ Calendar Code ------------- */
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

    let currentDate = new Date();
    let selectedDate = null;
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let currentView = 'day';
    let yearRangeStart = currentYear - 10;

    const dateInputDisplay = document.getElementById('dob_display');
    const calendarContainer = document.getElementById('calendarContainer');
    const monthYearElement = document.getElementById('monthYear');
    const calendarView = document.getElementById('calendarView');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const viewIndicator = document.getElementById('viewIndicator');
    const breadcrumb = document.getElementById('breadcrumb');
    const dobHidden = document.getElementById('dob_hidden');

    renderCalendar();

    dateInputDisplay.addEventListener('click', function(e) {
        e.stopPropagation();
        calendarContainer.classList.toggle('active');
    });
    calendarContainer.addEventListener('click', function(e) { e.stopPropagation(); });
    document.addEventListener('click', function() { calendarContainer.classList.remove('active'); });

    function renderCalendar() {
        calendarView.innerHTML = '';
        switch(currentView) {
            case 'day': renderDayView(); break;
            case 'month': renderMonthView(); break;
            case 'year': renderYearView(); break;
        }
        updateHeader();
        updateBreadcrumb();
    }

    function updateHeader() {
        if (currentView === 'day') { monthYearElement.textContent = `${monthNames[currentMonth]} ${currentYear}`; viewIndicator.textContent = "Click on month/year to change view"; }
        if (currentView === 'month') { monthYearElement.textContent = `${currentYear}`; viewIndicator.textContent = "Click on year to change view, click on month to select"; }
        if (currentView === 'year') { monthYearElement.textContent = `${yearRangeStart} - ${yearRangeStart + 19}`; viewIndicator.textContent = "Click on year to select"; }
    }

    function updateBreadcrumb() {
        breadcrumb.innerHTML = '';
        if (currentView === 'year') return;

        const yearItem = document.createElement('div');
        yearItem.className = 'breadcrumb-item';
        yearItem.textContent = currentYear;
        yearItem.addEventListener('click', function() { currentView = 'year'; renderCalendar(); });
        breadcrumb.appendChild(yearItem);

        if (currentView === 'day') {
            const separator = document.createElement('div');
            separator.className = 'breadcrumb-separator';
            separator.textContent = '>';
            breadcrumb.appendChild(separator);

            const monthItem = document.createElement('div');
            monthItem.className = 'breadcrumb-item';
            monthItem.textContent = monthNames[currentMonth];
            monthItem.addEventListener('click', function() { currentView = 'month'; renderCalendar(); });
            breadcrumb.appendChild(monthItem);
        }
    }

    function renderDayView() {
        const dayHeaders = document.createElement('div');
        dayHeaders.className = 'calendar-grid';
        dayNames.forEach(function(day) {
            const dayHeader = document.createElement('div'); dayHeader.className = 'day-header'; dayHeader.textContent = day;
            dayHeaders.appendChild(dayHeader);
        });
        calendarView.appendChild(dayHeaders);

        const dayGrid = document.createElement('div'); dayGrid.className = 'calendar-grid';
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) dayGrid.appendChild(document.createElement('div'));

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell';
            dayCell.textContent = day;

            const today = new Date();
            if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && day === today.getDate()) {
                dayCell.classList.add('today');
            }
            if (selectedDate &&
              currentYear === selectedDate.getFullYear() &&
              currentMonth === selectedDate.getMonth() &&
              day === selectedDate.getDate()) {
                dayCell.classList.add('selected');
            }

            dayCell.addEventListener('click', function() { selectDate(day); });
            dayGrid.appendChild(dayCell);
        }
        calendarView.appendChild(dayGrid);
    }

    function renderMonthView() {
        const monthGrid = document.createElement('div'); monthGrid.className = 'month-grid';
        monthNames.forEach(function(month, index) {
            const monthCell = document.createElement('div');
            monthCell.className = 'month-cell';
            monthCell.textContent = month.substring(0, 3);

            if (currentYear === (new Date()).getFullYear() && index === (new Date()).getMonth()) {
                monthCell.style.fontWeight = 'bold';
            }
            if (selectedDate && currentYear === selectedDate.getFullYear() && index === selectedDate.getMonth()) {
                monthCell.classList.add('selected');
            }
            monthCell.addEventListener('click', function() { currentMonth = index; currentView = 'day'; renderCalendar(); });
            monthGrid.appendChild(monthCell);
        });
        calendarView.appendChild(monthGrid);
    }

    function renderYearView() {
        const yearGrid = document.createElement('div'); yearGrid.className = 'year-grid';
        for (let i = 0; i < 20; i++) {
            const year = yearRangeStart + i;
            const yearCell = document.createElement('div'); yearCell.className = 'year-cell'; yearCell.textContent = year;
            if (year === (new Date()).getFullYear()) yearCell.style.fontWeight = 'bold';
            if (selectedDate && year === selectedDate.getFullYear()) yearCell.classList.add('selected');
            yearCell.addEventListener('click', function() { currentYear = year; currentView = 'month'; renderCalendar(); });
            yearGrid.appendChild(yearCell);
        }
        calendarView.appendChild(yearGrid);
    }

    function selectDate(day) {
        selectedDate = new Date(currentYear, currentMonth, day);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        dateInputDisplay.value = selectedDate.toLocaleDateString('en-US', options);
        const iso = selectedDate.toISOString().slice(0,10);
        dobHidden.value = iso;
        calendarContainer.classList.remove('active');
    }

    monthYearElement.addEventListener('click', function() {
        if (currentView === 'day') currentView = 'month';
        else if (currentView === 'month') currentView = 'year';
        renderCalendar();
    });

    prevButton.addEventListener('click', function() {
        switch(currentView) {
            case 'day':
                currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } break;
            case 'month':
                currentYear--; break;
            case 'year':
                yearRangeStart -= 20; break;
        }
        renderCalendar();
    });

    nextButton.addEventListener('click', function() {
        switch(currentView) {
            case 'day':
                currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } break;
            case 'month':
                currentYear++; break;
            case 'year':
                yearRangeStart += 20; break;
        }
        renderCalendar();
    });

    /* ---- Email/Phone toggle ---- */
    const emailMethod = document.getElementById('emailMethod');
    const phoneMethod = document.getElementById('phoneMethod');
    const emailField = document.getElementById('emailField');
    const phoneField = document.getElementById('phoneField');
    function toggleContact() {
        if (phoneMethod.checked) { phoneField.style.display = ''; emailField.style.display = 'none'; }
        else { emailField.style.display = ''; phoneField.style.display = 'none'; }
    }
    [emailMethod, phoneMethod].forEach(el => el.addEventListener('change', toggleContact));
    toggleContact();

    /* ---- Stepper ---- */
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const steps = Array.from(document.querySelectorAll('.step'));
    let stepIndex = steps.findIndex(s => s.classList.contains('active'));

    function showStep(i){
        steps.forEach(s => s.classList.remove('active'));
        steps[i].classList.add('active');
        document.querySelectorAll('.step-indicator').forEach((si,idx)=>{
            si.classList.toggle('active', idx===i);
        });
        prevBtn.disabled = i===0;
        nextBtn.style.display = i===steps.length-1 ? 'none' : '';
        submitBtn.style.display = i===steps.length-1 ? '' : 'none';
    }

    function validateStep(i) {
        let valid = true;
        const currentStep = steps[i];
        const inputs = currentStep.querySelectorAll("input, select, textarea");
        inputs.forEach(input => input.classList.remove("input-error"));

        inputs.forEach(input => {
            if (input.hasAttribute("required") && !input.value.trim()) {
                input.classList.add("input-error");
                valid = false;
            }
            if (input.type === "radio" && input.hasAttribute("required")) {
                const group = currentStep.querySelectorAll(`input[name='${input.name}']`);
                if (![...group].some(r => r.checked)) {
                    valid = false;
                }
            }
        });

        if (i === 3) {
            const pass = document.getElementById("password").value.trim();
            const confirmPass = document.getElementById("confirmPassword").value.trim();
            if (pass !== confirmPass || pass.length < 8) {
                alert("Passwords must match and be at least 8 characters long.");
                valid = false;
            }
        }

        if (i === 4) {
            const captcha = document.getElementById("captchaInput").value.trim();
            if (!captcha) {
                alert("Please solve the captcha.");
                valid = false;
            }
            const terms = document.getElementById("termsAgree");
            if (!terms.checked) {
                alert("You must agree to the terms.");
                valid = false;
            }
        }

        if (!valid) {
            alert("Please fill all required fields before proceeding.");
        }

        return valid;
    }

    prevBtn.addEventListener('click', ()=>{
        stepIndex=Math.max(0, stepIndex-1);
        showStep(stepIndex);
    });

    nextBtn.addEventListener('click', ()=>{
        if (!validateStep(stepIndex)) return;
        stepIndex=Math.min(steps.length-1, stepIndex+1);
        showStep(stepIndex);
    });

    const style = document.createElement("style");
    style.innerHTML = `.input-error { border: 2px solid red !important; }`;
    document.head.appendChild(style);

    showStep(stepIndex);

    /* ---- ‚úÖ Password Strength Meter ---- */
    const passwordInput = document.getElementById('password');
    const strengthBar = document.querySelector('.password-strength-meter');

    if (passwordInput && strengthBar) {
        passwordInput.addEventListener('input', () => {
            const value = passwordInput.value;
            let strength = 0;

            if (value.length >= 6) strength++;
            if (/[A-Z]/.test(value)) strength++;
            if (/[0-9]/.test(value)) strength++;
            if (/[^A-Za-z0-9]/.test(value)) strength++;

            strengthBar.className = 'password-strength-meter';

            if (strength <= 1) {
                strengthBar.classList.add('weak');
            } else if (strength === 2 || strength === 3) {
                strengthBar.classList.add('medium');
            } else if (strength >= 4) {
                strengthBar.classList.add('strong');
            }
        });
    }


</script>


</body>
</html>
