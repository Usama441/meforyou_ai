<main class="chat-wrapper">
  <div class="chat-box">
    <%= button_to "Logout", destroy_user_session_path,
                  method: :delete,
                  form: { data: { turbo: false } },
                  class: "auth-button" %>

    <div class="chat-header">
      <h1>MeForYou.AI</h1>
    </div>

    <p class="greeting">
      Hello <%= current_user.name.present? ? current_user.name.capitalize : "there" %>, ask something to your AI companion:
    </p>

    <div class="chat-history" id="chatHistory">
      <% @chats.each do |chat| %>
        <div class="chat-bubble user">
          <div class="avatar">ðŸ‘¤</div>
          <div>
            <p><strong>You:</strong> <%= chat.message %></p>
            <span class="timestamp"><%= chat.created_at.strftime("%H:%M") %></span>
          </div>
        </div>
        <div class="chat-bubble bot">
          <div class="avatar">ðŸ¤–</div>
          <div>
            <p><strong><%= current_user.ai_name || "AI" %>:</strong> <%= chat.reply %></p>
            <span class="timestamp"><%= chat.updated_at.strftime("%H:%M") %></span>
          </div>
        </div>
      <% end %>
    </div>

    <%# Optional: Session and Tone dropdowns %>
    <div class="chat-options">
      <%= form_with url: "/chat/stream", method: :post, local: false, html: { id: "chat-form" }, class: "chat-form" do %>
        <%= hidden_field_tag :session_id, params[:session_id] || "default" %>

        <div class="emoji-input-wrapper">
          <%= text_field_tag :message, nil, placeholder: "Type your message...", class: "chat-input", id: "chatInput", autocomplete: "off" %>
          <%= submit_tag "Send", class: "chat-send" %>
        </div>
      <% end %>
    </div>

    <%# Optional: Memory summarization trigger %>
    <div class="memory-summary">
      <%= button_to "Summarize Memory", summarize_memory_path(session_id: params[:session_id] || "default"), method: :post, class: "memory-summary-btn" %>
    </div>
  </div>
</main>

<script>
    document.addEventListener("turbo:load", function () {
        const chatHistory = document.getElementById("chatHistory");
        if (chatHistory) chatHistory.scrollTop = chatHistory.scrollHeight;
    });

    window.currentAIName = "<%= current_user.ai_name %>";
</script>
